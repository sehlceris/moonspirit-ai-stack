services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "8080:8080"  # Dashboard (local access only)
    volumes:
      - $HOME/.docker/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - web
    labels:
      - "traefik.enable=true"
      # Dashboard - local access only (no auth needed for local)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - web
    depends_on:
      - traefik

  # OpenWebUI - Web interface for LLMs
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    restart: unless-stopped
    volumes:
      # Persist all data: SQLite DB (users, chats, settings), uploads, cache
      - ./openwebui/data:/app/backend/data
    environment:
      # Explicitly set data directory (matches volume mount)
      - DATA_DIR=/app/backend/data
      - OPENAI_API_BASE_URL=http://host.docker.internal:1234/v1
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-no-key-required}
      - WEBUI_AUTH=${OPENWEBUI_AUTH:-true}
      - WEBUI_NAME=${OPENWEBUI_NAME:-AI Stack}
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-acfb1937b869a63b4e3e2bba09c8e8d81823f54f21efd3b06d4fd3215d279bea}
      - ENABLE_OLLAMA_API=false
      # Web search via SearXNG (internal)
      - ENABLE_RAG_WEB_SEARCH=true
      - RAG_WEB_SEARCH_ENGINE=searxng
      - SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>&format=json
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - web
    labels:
      - "traefik.enable=true"
      # External route (via Cloudflare) - with optional basic auth
      - "traefik.http.routers.openwebui-external.rule=Host(`openwebui.chrislee.dev`)"
      - "traefik.http.routers.openwebui-external.entrypoints=web"
      - "traefik.http.routers.openwebui-external.middlewares=${EXTERNAL_MIDDLEWARES:-auth@file}"
      - "traefik.http.routers.openwebui-external.service=openwebui"
      # Local route - no auth
      - "traefik.http.routers.openwebui-local.rule=Host(`openwebui.localhost`)"
      - "traefik.http.routers.openwebui-local.entrypoints=web"
      - "traefik.http.routers.openwebui-local.service=openwebui"
      # Service definition
      - "traefik.http.services.openwebui.loadbalancer.server.port=8080"

  # SearXNG - Internal search engine for OpenWebUI
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml:ro
    networks:
      - web
    # No Traefik labels - internal only, accessed by OpenWebUI via Docker network

  # LM Studio API Proxy - exposes host LLM through Traefik
  lmstudio-proxy:
    image: nginx:alpine
    container_name: lmstudio-proxy
    restart: unless-stopped
    volumes:
      - ./lmstudio-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - web
    labels:
      - "traefik.enable=true"
      # External route (via Cloudflare) - with optional basic auth
      - "traefik.http.routers.lmstudio-external.rule=Host(`lmstudio.chrislee.dev`)"
      - "traefik.http.routers.lmstudio-external.entrypoints=web"
      - "traefik.http.routers.lmstudio-external.middlewares=${EXTERNAL_MIDDLEWARES:-auth@file}"
      - "traefik.http.routers.lmstudio-external.service=lmstudio"
      # Local route - no auth
      - "traefik.http.routers.lmstudio-local.rule=Host(`lmstudio.localhost`)"
      - "traefik.http.routers.lmstudio-local.entrypoints=web"
      - "traefik.http.routers.lmstudio-local.service=lmstudio"
      # Service definition
      - "traefik.http.services.lmstudio.loadbalancer.server.port=80"

  # MongoDB - Database for LibreChat
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: unless-stopped
    volumes:
      - ./librechat/data-node:/data/db
    networks:
      - web
    # No Traefik labels - internal only, accessed by LibreChat via Docker network

  # LibreChat - Multi-model AI chat interface
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    depends_on:
      - mongodb
    volumes:
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./librechat/images:/app/client/public/images
      - ./librechat/logs:/app/api/logs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Server configuration
      - HOST=0.0.0.0
      - PORT=3080
      - MONGO_URI=mongodb://mongodb:27017/LibreChat
      # Security keys (generate your own for production)
      - CREDS_KEY=${LIBRECHAT_CREDS_KEY:-f34be427ebb29de8d88c107a71546019685ed8b241d8f2ed00c3df97ad2566f0}
      - CREDS_IV=${LIBRECHAT_CREDS_IV:-e2341419ec3dd3d19b13a1a87fafcbfb}
      - JWT_SECRET=${LIBRECHAT_JWT_SECRET:-16f8c0ef4a5d391b26034086c628469d3f9f497f08163ab9b40137092f2909ef}
      - JWT_REFRESH_SECRET=${LIBRECHAT_JWT_REFRESH_SECRET:-eaa5191f2914e30b9387fd84e254e4ba6fc51b4654968a9b0803b456a54b8418}
      # Allow registration (set to false after creating admin user)
      - ALLOW_REGISTRATION=${LIBRECHAT_ALLOW_REGISTRATION:-true}
      - ALLOW_SOCIAL_LOGIN=false
      # Enable web search via SearXNG
      - SEARCH=true
    networks:
      - web
    labels:
      - "traefik.enable=true"
      # External route (via Cloudflare) - with optional basic auth
      - "traefik.http.routers.librechat-external.rule=Host(`librechat.chrislee.dev`)"
      - "traefik.http.routers.librechat-external.entrypoints=web"
      - "traefik.http.routers.librechat-external.middlewares=${EXTERNAL_MIDDLEWARES:-auth@file}"
      - "traefik.http.routers.librechat-external.service=librechat"
      # Local route - no auth
      - "traefik.http.routers.librechat-local.rule=Host(`librechat.localhost`)"
      - "traefik.http.routers.librechat-local.entrypoints=web"
      - "traefik.http.routers.librechat-local.service=librechat"
      # Service definition
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"

networks:
  web:
    driver: bridge
